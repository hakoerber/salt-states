{% from 'states/postfix/map.jinja' import postfix as postfix_map with context %}
{% from 'states/defaults.map.jinja' import defaults with context %}
{% include 'states/postfix/files/main.cf.common.jinja' with context %}

# listening
inet_interfaces = $myhostname, localhost
inet_protocols  = all

# receiving
{% if domain_authorative %}
mydestination        = $myhostname, localhost.$mydomain, localhost, $mydomain
{% else %}
mydestination        = $myhostname, localhost.$mydomain, localhost
{% endif %}
local_recipient_maps = $alias_maps

# hostnames
myhostname = {{ hostname }}
mydomain   = {{ domain }}
myorigin   = $mydomain

# misc
allow_mail_to_commands =
allow_mail_to_files =
recipient_delimiter = +
show_user_unknown_table_name = no
smtp_cname_overrides_servername = no
smtp_tls_block_early_mail_reply = yes
strict_rfc821_envelopes = yes
smtpd_helo_required = yes

# lookups
alias_maps     = hash:{{ postfix_map.aliasesfile }}
alias_database = hash:{{ postfix_map.aliasesfile }}

# handlers
daemon_table_open_error_is_fatal = yes

# tls
smtpd_use_tls = yes
smtpd_tls_auth_only = yes
smtpd_tls_key_file          = {{ postfix_map.pkidir }}/{{ postfix_map.key }}
smtpd_tls_cert_file         = {{ postfix_map.pkidir }}/{{ postfix_map.cert }}
smtpd_tls_dh1024_param_file = {{ postfix_map.pkidir }}/{{ postfix_map.dhparams }}
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3
smtpd_tls_protocols = !SSLv2, !SSLv3
smtpd_tls_loglevel = 1

# relaying
mynetworks_style = host
relay_domains =
{% if relay is not none %}
relayhost = [{{ relay.server }}]:{{ relay.port|default(postfix_map.ports.submit) }}
smtp_use_tls = yes
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_tls_CAfile = {{ postfix_map.ca_file }}
{% endif %}
